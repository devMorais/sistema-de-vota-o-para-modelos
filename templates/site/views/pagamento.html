{% extends 'base.html' %}

{% block topo %}{% endblock %}
{% block rodape %}{% endblock %}

{% block conteudo %}
<div class="payment-wrapper">
    <div class="container py-5">
        <div class="row justify-content-center">
            <div class="col-md-5 col-lg-4">

                {# ==================== TELA: SUCESSO (PAGO) ==================== #}
                {% if pedido.status == 'PAGO' %}
                <div class="card card-status card-success animate-fade-in">
                    <div class="card-header-status text-center py-5">
                        <div class="icon-circle mb-3 shadow-sm">
                            <i class="fa-solid fa-check"></i>
                        </div>
                        <h2 class="fw-bold mb-0">Voto Confirmado</h2>
                        <p class="opacity-75 mb-0">Obrigado pelo seu apoio!</p>
                    </div>

                    <div class="card-body p-4">
                        <div class="summary-box mb-4">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <span class="label">Candidata</span>
                                <span class="value text-primary fs-5">{{ pedido.post().titulo|striptags }}</span>
                            </div>
                            <div class="row border-top border-dark-subtle pt-3">
                                <div class="col-6 text-center border-end border-dark-subtle">
                                    <span class="label d-block">Votos</span>
                                    <span class="value h3 mb-0">{{ pedido.total_votos }}</span>
                                </div>
                                <div class="col-6 text-center">
                                    <span class="label d-block">Valor</span>
                                    <span class="value h3 mb-0 text-success">R$ {{ pedido.valor_total|number_format(2,
                                        ',', '.') }}</span>
                                </div>
                            </div>
                        </div>

                        <div class="audit-details mb-4">
                            <div class="d-flex justify-content-between"><span>Doador</span><strong>{{
                                    pedido.cliente_nome }}</strong></div>
                            <div class="d-flex justify-content-between"><span>Pedido</span><strong>#{{ pedido.id
                                    }}</strong></div>
                            <div class="d-flex justify-content-between"><span>Gateway</span><strong>{{
                                    pedido.gateway_usado }}</strong></div>
                        </div>

                        {% if pedido.infinitepay_receipt_url %}
                        <div class="d-grid mb-3">
                            <a href="{{ pedido.infinitepay_receipt_url }}" target="_blank"
                                class="btn btn-outline-success btn-sm">
                                <i class="fa-solid fa-receipt me-2"></i>Ver Recibo Oficial
                            </a>
                        </div>
                        {% endif %}

                        <div class="d-grid">
                            <a href="{{ url() }}" class="btn btn-primary btn-lg rounded-pill shadow">Voltar ao
                                Início</a>
                        </div>
                    </div>
                </div>

                {% elseif pedido.status == 'ERRO' %}
                {# ==================== TELA: ERRO ==================== #}
                <div class="card card-status card-dark py-5 text-center">
                    <div class="card-body">
                        <i class="fa-solid fa-circle-xmark text-danger mb-3" style="font-size: 3.5rem;"></i>
                        <h4 class="text-white fw-bold">Falha no Pagamento</h4>
                        <p class="text-secondary small" id="mensagem-erro">Ocorreu um erro ao processar a transação.</p>
                        <a href="{{ url() }}" class="btn btn-outline-light rounded-pill mt-3">Tentar Novamente</a>
                    </div>
                </div>

                {% else %}
                {# ==================== TELA: AGUARDANDO (PIX / CARTÃO) ==================== #}
                <div class="card card-status card-dark shadow-lg">
                    <div class="card-body p-4">
                        <div class="text-center mb-4">
                            <span
                                class="badge bg-dark border border-secondary text-secondary px-3 py-2 rounded-pill text-uppercase"
                                style="font-size: 0.65rem; letter-spacing: 1.5px;">Aguardando Pagamento</span>
                        </div>

                        <div class="text-center mb-4">
                            <h1 class="display-6 fw-bold text-white mb-0">R$ {{ pedido.valor_total|number_format(2, ',',
                                '.') }}</h1>
                            <p class="text-secondary small text-uppercase mt-1">Total do Pedido #{{ pedido.id }}</p>
                        </div>

                        {% if tipoPagamento == 'PIX' %}
                        <div class="pix-container text-center mb-4 p-3 bg-white rounded-4 shadow-inner">
                            <img src="data:image/png;base64,{{ imagemQrcode }}" class="img-fluid mb-3"
                                style="max-height: 180px;">
                            <div class="input-group input-group-sm">
                                <input type="text" class="form-control text-center bg-light border-0"
                                    value="{{ copiaCola }}" id="pixCopiaCola" readonly>
                                <button class="btn btn-dark fw-bold px-3" onclick="copiarPix()">COPIAR</button>
                            </div>
                        </div>
                        {% endif %}

                        <div
                            class="status-box text-center py-3 bg-black bg-opacity-25 rounded-3 border border-secondary border-opacity-10">
                            <div class="spinner-border text-primary spinner-border-sm mb-2" role="status"></div>
                            <p class="text-secondary mb-0" style="font-size: 0.8rem;" id="status-pedido">Sincronizando
                                com o banco...</p>
                        </div>

                        <div class="d-grid mt-4">
                            <button onclick="verificarManualmente()"
                                class="btn btn-link text-secondary text-decoration-none btn-sm opacity-50"
                                id="btn-verificar">
                                <i class="fa-solid fa-rotate me-1"></i> Já paguei, verificar agora
                            </button>
                        </div>
                    </div>
                </div>
                {% endif %}

                <div class="text-center mt-4">
                    <a href="{{ url() }}"
                        class="text-secondary text-decoration-none small opacity-25 hover-opacity-100">
                        <i class="fa-solid fa-arrow-left me-1"></i> Cancelar e Voltar
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    :root {
        --dark-bg: #0a0c10;
        --card-bg: #16191f;
        --primary-blue: #3b82f6;
    }

    body {
        background-color: var(--dark-bg);
        color: #e2e8f0;
        font-family: 'Inter', system-ui, -apple-system, sans-serif;
    }

    .card-status {
        background: var(--card-bg);
        border: 1px solid #2d333b;
        border-radius: 28px;
    }

    .card-success .card-header-status {
        background: linear-gradient(135deg, #065f46 0%, #10b981 100%);
        color: white;
    }

    .icon-circle {
        width: 70px;
        height: 70px;
        background: rgba(255, 255, 255, 0.15);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto;
        font-size: 2rem;
    }

    .summary-box {
        background: rgba(0, 0, 0, 0.3);
        border-radius: 18px;
        padding: 24px;
    }

    .label {
        font-size: 0.65rem;
        color: #64748b;
        text-transform: uppercase;
        font-weight: 700;
        letter-spacing: 1px;
    }

    .value {
        color: #f1f5f9;
        font-weight: 700;
    }

    .audit-details {
        font-size: 0.8rem;
        color: #475569;
    }

    .audit-details div {
        border-bottom: 1px solid rgba(255, 255, 255, 0.03);
        padding: 6px 0;
    }

    .hover-opacity-100:hover {
        opacity: 1 !important;
        transition: 0.3s;
    }

    .animate-fade-in {
        animation: fadeInUp 0.4s ease-out;
    }

    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(15px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
</style>
{% endblock %}

{% block scripts %}
<script>
    $(document).ready(function () {
        var pid = "{{ pedido.id }}";
        var urlCheck = "{{ url('pedido/verificar') }}";
        var statusInit = "{{ pedido.status }}";
        var gateway = "{{ pedido.gateway_usado }}";

        if (statusInit !== 'PAGO' && statusInit !== 'ERRO') {
            // ✅ Polling otimizado: 1s para InfinitePay (retorno rápido), 3s para Asaas 
            var timer = (gateway === 'INFINITEPAY') ? 1000 : 3000;
            var interval = setInterval(function () {
                $.post(urlCheck, { id: pid }, function (res) {
                    if (res.pago || res.status === 'PAGO') {
                        clearInterval(interval);
                        window.location.reload();
                    }
                }, 'json');
            }, timer);
        }
    });

    function verificarManualmente() {
        var btn = $('#btn-verificar');
        btn.html('<i class="fa-solid fa-spinner fa-spin"></i> Verificando...');
        $.post("{{ url('pedido/verificar') }}", { id: "{{ pedido.id }}" }, function (res) {
            if (res.pago || res.status === 'PAGO') {
                window.location.reload();
            } else {
                btn.html('<i class="fa-solid fa-rotate me-1"></i> Já paguei, verificar agora');
            }
        }, 'json');
    }

    function copiarPix() {
        var input = document.getElementById('pixCopiaCola');
        input.select();
        document.execCommand('copy');
        alert("PIX Copiado!");
    }
</script>
{% endblock %}