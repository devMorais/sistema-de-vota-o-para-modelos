{% extends 'base.html' %}

{% block topo %}{% endblock %}
{% block rodape %}{% endblock %}

{% block conteudo %}
<div class="payment-container">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-md-5 col-lg-4">

                {# ==================== TRAVA DE SEGURAN√áA: J√Å PAGO ==================== #}
                {% if pedido.status == 'PAGO' %}
                <div class="min-vh-100 d-flex align-items-center justify-content-center"
                    style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                    <div class="card shadow-lg border-0"
                        style="border-radius: 20px; overflow: hidden; max-width: 600px; width: 100%;">
                        <div class="text-center py-5"
                            style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);">
                            <div class="mb-3"><i class="fa-solid fa-circle-check text-white"
                                    style="font-size: 80px;"></i></div>
                            <h2 class="text-white fw-bold mb-0">Pagamento Confirmado!</h2>
                            <p class="text-white-50 mb-0 mt-2">Seus votos foram computados</p>
                        </div>
                        <div class="card-body p-4 p-md-5">
                            <h5 class="fw-bold mb-3 text-center">üìä Detalhes da Vota√ß√£o</h5>
                            <div class="bg-light rounded p-4 mb-3">
                                <div class="row g-3">
                                    <div class="col-12 mb-3 border-bottom pb-3 text-center">
                                        <div class="text-muted small mb-1">Candidata</div>
                                        <div class="fs-5 fw-bold text-primary">{{ pedido.post().titulo|striptags }}
                                        </div>
                                    </div>
                                    <div class="col-6 text-center">
                                        <div class="text-muted small mb-1">Total de Votos</div>
                                        <div class="fs-2 fw-bold text-primary">{{ pedido.total_votos }}</div>
                                    </div>
                                    <div class="col-6 text-center">
                                        <div class="text-muted small mb-1">Valor Pago</div>
                                        <div class="fs-2 fw-bold text-success">R$ {{ pedido.valor_total|number_format(2,
                                            ',', '.') }}</div>
                                    </div>
                                </div>
                            </div>

                            {% if pedido.infinitepay_receipt_url %}
                            <div class="d-grid mb-3">
                                <a href="{{ pedido.infinitepay_receipt_url }}" target="_blank"
                                    class="btn btn-success btn-lg">
                                    <i class="fa-solid fa-receipt me-2"></i>Ver Comprovante InfinitePay
                                </a>
                            </div>
                            {% endif %}

                            <div class="border rounded p-3 bg-light mb-4">
                                <div class="d-flex justify-content-between py-1 small"><span>Nome:</span><strong>{{
                                        pedido.cliente_nome }}</strong></div>
                                <div class="d-flex justify-content-between py-1 small"><span>Pedido:</span><strong>#{{
                                        pedido.id }}</strong></div>
                                <div class="d-flex justify-content-between py-1 small"><span>M√©todo:</span><strong>{{
                                        pedido.metodo_pagamento }}</strong></div>
                                <div class="d-flex justify-content-between py-1 small"><span>Gateway:</span><strong>{{
                                        pedido.gateway_usado }}</strong></div>
                            </div>
                            <div class="alert alert-success border-0 mb-4">
                                <div class="d-flex"><i class="fa-solid fa-heart text-danger fs-3 me-3"></i>
                                    <div><strong>Obrigado pelo seu apoio!</strong>
                                        <p class="mb-0 small">Sua candidata agradece sua participa√ß√£o!</p>
                                    </div>
                                </div>
                            </div>
                            <div class="d-grid gap-2">
                                <button onclick="window.print()" class="btn btn-outline-primary"><i
                                        class="fa-solid fa-print me-2"></i>Imprimir</button>
                                <a href="{{ url() }}" class="btn btn-primary btn-lg">Voltar ao In√≠cio</a>
                            </div>
                        </div>
                    </div>
                </div>

                {% elseif pedido.status == 'ERRO' %}
                {# ==================== TELA DE ERRO ==================== #}
                <div class="text-center mb-4">
                    <i class="fa-solid fa-circle-xmark text-danger fa-3x mb-2"></i>
                    <h4 class="fw-light text-uppercase ls-2 text-white">Erro no Pagamento</h4>
                </div>

                <div class="card card-dark p-4">
                    <div class="alert alert-danger mb-4">
                        <i class="fa-solid fa-exclamation-triangle fa-2x mb-3 d-block"></i>
                        <h5 class="fw-bold">Ops! Algo deu errado</h5>
                        <p class="mb-0 small" id="mensagem-erro">N√£o foi poss√≠vel processar seu pagamento.</p>
                    </div>

                    <div class="border-top pt-3 mb-4">
                        <p class="text-secondary small mb-2"><strong>Detalhes do pedido:</strong></p>
                        <div class="d-flex justify-content-between small mb-1">
                            <span class="text-muted">Pedido:</span>
                            <strong class="text-white">#{{ pedido.id }}</strong>
                        </div>
                        <div class="d-flex justify-content-between small mb-1">
                            <span class="text-muted">Valor:</span>
                            <strong class="text-white">R$ {{ pedido.valor_total|number_format(2, ',', '.') }}</strong>
                        </div>
                        <div class="d-flex justify-content-between small">
                            <span class="text-muted">Candidata:</span>
                            <strong class="text-white">{{ pedido.post().titulo|striptags }}</strong>
                        </div>
                    </div>

                    <div class="d-grid gap-2">
                        <a href="https://wa.me/{{ whatsapp }}?text=Ol√°!%20Tive%20um%20problema%20com%20o%20pagamento%20do%20pedido%20%23{{ pedido.id }}"
                            target="_blank" class="btn btn-success btn-lg">
                            <i class="fa-brands fa-whatsapp me-2"></i>
                            Falar com Suporte
                        </a>

                        <a href="{{ url('post/' ~ pedido.post().categoria().slug ~ '/' ~ pedido.post().slug) }}"
                            class="btn btn-outline-light btn-lg">
                            <i class="fa-solid fa-rotate-right me-2"></i>
                            Tentar Novamente
                        </a>

                        <a href="{{ url() }}" class="btn btn-outline-secondary">
                            <i class="fa-solid fa-home me-2"></i>
                            Voltar ao In√≠cio
                        </a>
                    </div>
                </div>

                {% elseif tipoPagamento == 'PIX' %}
                {# ==================== PAGAMENTO PIX (AGUARDANDO) ==================== #}
                <div class="text-center mb-4">
                    <i class="fa-brands fa-pix text-success fa-3x mb-2"></i>
                    <h4 class="fw-light text-uppercase ls-2 text-white">Pagamento PIX</h4>
                </div>

                <div class="card card-dark p-4 text-center">
                    <div class="mb-4">
                        <p class="text-secondary small text-uppercase mb-1">Total a pagar</p>
                        <h1 class="fw-bold text-white">R$ {{ pedido.valor_total|number_format(2, ',', '.') }}</h1>
                    </div>

                    <div class="mb-4 d-flex justify-content-center">
                        <div class="bg-white p-2 rounded-1">
                            <img src="data:image/png;base64,{{ imagemQrcode }}" class="img-fluid"
                                style="max-width: 200px;">
                        </div>
                    </div>

                    <div class="input-group mb-3">
                        <input type="text" class="form-control form-control-dark" value="{{ copiaCola }}"
                            id="pixCopiaCola" readonly>
                        <button class="btn btn-light fw-bold" type="button" onclick="copiarPix()">
                            COPIAR
                        </button>
                    </div>

                    <div class="mt-4">
                        <div class="spinner-border spinner-border-sm text-success mb-2" role="status"></div>
                        <p class="text-secondary small mb-0">Aguardando confirma√ß√£o autom√°tica...</p>
                        <p class="text-muted small mt-1">Status: <strong id="status-pedido">AGUARDANDO</strong></p>
                    </div>
                </div>

                {% else %}
                {# ==================== PAGAMENTO CART√ÉO / INFINITEPAY (AGUARDANDO) ==================== #}
                <div class="text-center mb-4">
                    <i class="fa-solid fa-credit-card text-warning fa-3x mb-2"></i>
                    <h4 class="fw-light text-uppercase ls-2 text-white">Processando Pagamento</h4>
                </div>

                <div class="card card-dark p-4 text-center">
                    <div class="mb-4">
                        <p class="text-secondary small text-uppercase mb-1">Valor do Pedido</p>
                        <h1 class="fw-bold text-white">R$ {{ pedido.valor_total|number_format(2, ',', '.') }}</h1>
                    </div>

                    <div class="mb-4">
                        <div class="spinner-border text-warning mb-3" role="status" style="width: 3rem; height: 3rem;">
                            <span class="visually-hidden">Processando...</span>
                        </div>
                        <p class="text-secondary small mb-0">Aguardando confirma√ß√£o do pagamento.</p>
                        <p class="text-muted small mt-2">Status: <strong id="status-pedido">{{ pedido.status }}</strong>
                        </p>
                    </div>

                    <div class="alert alert-info small text-start mb-3">
                        <i class="fa-solid fa-info-circle me-2"></i>
                        Se voc√™ j√° concluiu o pagamento, aguarde nesta tela. A confirma√ß√£o √© autom√°tica.
                    </div>

                    {% if pedido.gateway_usado == 'INFINITEPAY' %}
                    <div class="d-grid">
                        <button onclick="verificarManualmente()" class="btn btn-outline-light" id="btn-verificar">
                            <i class="fa-solid fa-rotate me-2"></i>
                            J√° paguei - Verificar Status
                        </button>
                    </div>
                    {% endif %}
                </div>
                {% endif %}

                <div class="text-center mt-4">
                    <a href="{{ url() }}" class="text-secondary text-decoration-none small">
                        <i class="fa-solid fa-arrow-left me-1"></i> Voltar ao In√≠cio
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .card-dark {
        background-color: #1a1a1a;
        border: 1px solid #333;
        color: #fff;
    }

    .form-control-dark {
        background-color: #2b2b2b;
        border-color: #444;
        color: #fff;
    }

    .form-control-dark:focus {
        background-color: #333;
        border-color: #555;
        color: #fff;
    }

    .ls-2 {
        letter-spacing: 2px;
    }
</style>
{% endblock %}

{% block scripts %}
<script>
    $(document).ready(function () {
        var pedidoId = {{ pedido.id }
    }; // Corrigido: Removida a chave sobrando
    var urlVerificacao = "{{ url('pedido/verificar') }}";
    var pedidoStatusInicial = "{{ pedido.status }}";

    // ‚úÖ SE J√Å EST√Å PAGO, N√ÉO FAZ POLLING
    if (pedidoStatusInicial === 'PAGO') return;

    // ‚úÖ SE FOR ERRO, BUSCA MENSAGEM
    if (pedidoStatusInicial === 'ERRO') {
        $.post("{{ url('pedido/erro') }}", { pedido_id: pedidoId }, function (res) {
            if (res.mensagem) $('#mensagem-erro').text(res.mensagem);
        }, 'json');
        return;
    }

    // ‚úÖ POLLING COM TIMEOUT (3 minutos)
    var tentativas = 0;
    var intervalo = setInterval(function () {
        tentativas++;
        if (tentativas >= 60) {
            clearInterval(intervalo);
            $('#status-pedido').html('<span class="text-warning">Tempo esgotado. <a href="#" onclick="location.reload()" class="text-white">Atualizar</a></span>');
            return;
        }

        $.ajax({
            url: urlVerificacao,
            type: 'POST',
            data: { id: pedidoId },
            dataType: 'json',
            success: function (response) {
                // Confirma√ß√£o via resposta JSON profissional
                if (response.pago || response.status === 'PAGO') {
                    clearInterval(intervalo);
                    window.location.reload();
                } else {
                    $('#status-pedido').text('Aguardando confirma√ß√£o...');
                }
            }
        });
    }, 3000);
    });

    function verificarManualmente() {
        var btn = $('#btn-verificar');
        btn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm me-2"></span>Verificando...');

        $.post("{{ url('pedido/verificar') }}", { id: {{ pedido.id }} }, function (response) {
            if (response.pago || response.status === 'PAGO') {
                window.location.reload();
            } else {
                btn.prop('disabled', false).html('<i class="fa-solid fa-rotate me-2"></i>J√° paguei - Verificar Status');
                $('#status-pedido').html('<span class="text-warning">Ainda n√£o confirmado</span>');
            }
        }, 'json').fail(function () {
            btn.prop('disabled', false).html('<i class="fa-solid fa-rotate me-2"></i>J√° paguei - Verificar Status');
        });
    }

    function copiarPix() {
        var input = document.getElementById('pixCopiaCola');
        input.select();
        document.execCommand('copy');
        alert("C√≥digo PIX copiado!");
    }
</script>
{% endblock %}